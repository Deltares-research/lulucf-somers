
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lusos concept &#8212; LULUCF SOMERS Shell (LUSOS)  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/theme-deltares.css?v=44e194b5" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/concept';</script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Calculate coverage example" href="coverage.html" />
    <link rel="prev" title="User guide" href="../user_guide.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.2.4" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/lusos_logo.svg" class="logo__image only-light" alt=""/>
    <img src="../_static/lusos_logo.svg" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">LULUCF SOMERS Shell</p>
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../index.html">
    Home
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about.html">
    About
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../user_guide.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api_reference.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Deltares-research/lusos" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://deltares.nl/en/" title="Deltares" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../_static/deltares-blue.svg" class="icon-link-image" alt="Deltares"/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../index.html">
    Home
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about.html">
    About
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../user_guide.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api_reference.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Deltares-research/lusos" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://deltares.nl/en/" title="Deltares" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../_static/deltares-blue.svg" class="icon-link-image" alt="Deltares"/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Table of contents</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="coverage.html">Calculate coverage</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../user_guide.html" class="nav-link">User guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Lusos concept</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="lusos-concept">
<h1>Lusos concept<a class="headerlink" href="#lusos-concept" title="Link to this heading">#</a></h1>
<p>This notebook explains the general concept how <code class="docutils literal notranslate"><span class="pre">lusos</span></code> works. Under the hood, lusos utilizes the <a class="reference external" href="https://pypi.org/project/mapbox-earcut/">mapbox-earcut</a> library and <a class="reference external" href="https://deltares.github.io/xugrid/index.html">Xugrid</a> unstructured grids to derive coverages of polygon geometries in a GeoDataFrame within raster cells of a grid. This is done in three steps:</p>
<ol class="arabic simple">
<li><p>Translate the polygon geometries to triangles, using <code class="docutils literal notranslate"><span class="pre">mapbox_earcut</span></code>, to create an unstructured grid (ugrid) from the geometries.</p></li>
<li><p>Compute the overlap between every triangle in the ugrid and each raster cell from a target grid using <a class="reference external" href="https://deltares.github.io/xugrid/api/xugrid.OverlapRegridder.html#xugrid.OverlapRegridder">xugrid.OverlapRegridder</a>.</p></li>
<li><p>Store the computed overlaps back in the same rectangular space as the target grid.</p></li>
</ol>
<p>Normally, lusos does all this under the hood but for the explanation of the concept we are going to untangle these steps to show how it works. We begin with the necessary imports.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xugrid</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">box</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lusos</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lusos.area_statistics</span><span class="w"> </span><span class="kn">import</span> <span class="n">area_to_grid3d</span>
</pre></div>
</div>
</div>
</div>
<p>In this example we will use some random polygons created in the space between (0, 0) and (1, 1). First, we need to define two helper functions: (1) to create a <a class="reference external" href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.html">GeoDataFrame</a> containing some random polygons with a “nr” identifying its category and, (2) to be able to visualize the outer edges of raster cells in a grid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">random_polygons</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">polygons</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;nr&quot;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)},</span>
        <span class="n">geometry</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">)),</span>
        <span class="n">crs</span><span class="o">=</span><span class="mi">28992</span>
    <span class="p">)</span>
    <span class="n">polygons</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">voronoi_polygons</span><span class="p">()</span>
    <span class="n">polygons</span> <span class="o">=</span> <span class="n">polygons</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">polygons</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">grid_to_cells</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">):</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">grid</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">cells</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="mi">28992</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s now create the polygons and grid with the extent between 0, 0, 1, 1 (xmin, ymin, xmax, ymax). For the grid we will use a cell size of 0.2 which results in a 5x5 grid (rows, columns). Let’s check out the created polygons and visualize what the polygons and grid look like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">polygons</span> <span class="o">=</span> <span class="n">random_polygons</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span> <span class="c1"># Use seed for reproducibility</span>
<span class="nb">print</span><span class="p">(</span><span class="n">polygons</span><span class="p">)</span>

<span class="n">grid</span> <span class="o">=</span> <span class="n">lusos</span><span class="o">.</span><span class="n">LassoGrid</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span> <span class="c1"># 5x5 grid between (0,0) and (1,1)</span>
<span class="n">cells</span> <span class="o">=</span> <span class="n">grid_to_cells</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">dataarray</span><span class="p">(),</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">polygons</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">column</span><span class="o">=</span><span class="s1">&#39;nr&#39;</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Pastel2&#39;</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">legend_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bbox_to_anchor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="s1">&#39;upper right&#39;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">cells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   nr                                           geometry
0   2   POLYGON ((0.22 0, 0.659 0.254, 0.726 0, 0.22 0))
1   2  POLYGON ((0.659 0.254, 0.668 0.304, 1 0.468, 1...
2   1  POLYGON ((0 0, 0 0.168, 0.093 0.26, 0.461 0.47...
3   0  POLYGON ((0 0.168, 0 0.828, 0.11 0.77, 0.173 0...
4   0  POLYGON ((0.093 0.26, 0.173 0.731, 0.259 0.715...
5   1  POLYGON ((0.455 0.508, 0.652 0.807, 1 0.683, 1...
6   1  POLYGON ((0.259 0.715, 0.535 1, 0.543 1, 0.652...
7   2  POLYGON ((0.11 0.77, 0.368 1, 0.535 1, 0.259 0...
8   0  POLYGON ((0.543 1, 1 1, 1 0.683, 0.652 0.807, ...
9   2  POLYGON ((0 0.828, 0 1, 0.368 1, 0.11 0.77, 0 ...
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: &gt;
</pre></div>
</div>
<img alt="../_images/f2c100ba10b713a590cd99274e5b9a33422be8c9e2f2b0c8135c7b53197108ed.png" src="../_images/f2c100ba10b713a590cd99274e5b9a33422be8c9e2f2b0c8135c7b53197108ed.png" />
</div>
</div>
<p>The created GeoDataFrame contains 10 polygons belonging to one of three categories: 0, 1 or 2. Lusos calculates for each cell in a grid, in this case the 5x5 grid, the percentage of the cell that is covered by each category. The result will therefore be a 3D grid with the category as an extra dimension (lusos calls this dimension “layer”). The resulting grid will therefore be a 5x5x3 (“y”, “x”, “layer”) grid with the percentage of each “layer” at every “y”, “x” coordinate.</p>
<p>The first step of the calculation is the triangulation of the input polygons. Let’s create the triangulation and unstructured grid and show what the result of the triangulation looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">triangles</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="n">lusos</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">triangulate</span><span class="p">(</span><span class="n">polygons</span><span class="p">)</span>
<span class="n">ugrid</span> <span class="o">=</span> <span class="n">xu</span><span class="o">.</span><span class="n">Ugrid2d</span><span class="p">(</span><span class="o">*</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">triangles</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">polygons</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># plot outlines of polygons</span>
<span class="n">ugrid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">polygons</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">column</span><span class="o">=</span><span class="s1">&#39;nr&#39;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Pastel2&#39;</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">legend_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bbox_to_anchor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="s1">&#39;upper right&#39;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: &gt;
</pre></div>
</div>
<img alt="../_images/1b99e6fb73b4649b1cd1d22c2b4d2bf3560ce0a435ce6cf522916011a8de1453.png" src="../_images/1b99e6fb73b4649b1cd1d22c2b4d2bf3560ce0a435ce6cf522916011a8de1453.png" />
</div>
</div>
<p>Now that we have a basic understanding of the triangulation, we can calculate the overlapping areas of each polygon in each grid cell. The result is a namedtuple <code class="docutils literal notranslate"><span class="pre">PolygonGridArea</span></code> containing four different fields: <code class="docutils literal notranslate"><span class="pre">cell_idx</span></code>, <code class="docutils literal notranslate"><span class="pre">nitems</span></code>, <code class="docutils literal notranslate"><span class="pre">polygon</span></code> and <code class="docutils literal notranslate"><span class="pre">area</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cell_idx</span></code> is a flat array with ordered indices of cells that have nonzero values (i.e. cell overlaps a polygon)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nitems</span></code> is a flat array that contains the number of polygons that overlap with each polygon</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">polygon</span></code> is the original row index in the GeoDataFrame of the polygon that overlaps with a cell</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">area</span></code> is the corresponding area.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">area</span> <span class="o">=</span> <span class="n">lusos</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">polygon_area_in_grid</span><span class="p">(</span><span class="n">polygons</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">dataarray</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">area</span> <span class="o">=</span> <span class="n">lusos</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">polygon_area_in_grid</span><span class="p">(</span><span class="n">polygons</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">dataarray</span><span class="p">())</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="nb">print</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\lusos\geometry\ops.py:72,</span> in <span class="ni">polygon_area_in_grid</span><span class="nt">(polygons, grid)</span>
<span class="g g-Whitespace">     </span><span class="mi">69</span> <span class="n">triangles</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="n">triangulate</span><span class="p">(</span><span class="n">polygons</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">71</span> <span class="n">ugrid</span> <span class="o">=</span> <span class="n">xu</span><span class="o">.</span><span class="n">Ugrid2d</span><span class="p">(</span><span class="o">*</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">triangles</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">72</span> <span class="n">regridder</span> <span class="o">=</span> <span class="n">xu</span><span class="o">.</span><span class="n">OverlapRegridder</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ugrid</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">73</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">regridder</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">75</span> <span class="n">cell_idx_pointer</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;__regrid_indptr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\xugrid\regrid\regridder.py:507,</span> in <span class="ni">OverlapRegridder.__init__</span><span class="nt">(self, source, target, method)</span>
<span class="g g-Whitespace">    </span><span class="mi">501</span> <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">502</span>     <span class="bp">self</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">503</span>     <span class="n">source</span><span class="p">:</span> <span class="n">UgridDataArray</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">504</span>     <span class="n">target</span><span class="p">:</span> <span class="n">UgridDataArray</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">505</span>     <span class="n">method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">506</span> <span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">507</span>     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">508</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_setup_regrid</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\xugrid\regrid\regridder.py:108,</span> in <span class="ni">BaseRegridder.__init__</span><span class="nt">(self, source, target, tolerance)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">setup_grid</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="kc">None</span>
<span class="ne">--&gt; </span><span class="mi">108</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span> <span class="k">return</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\xugrid\regrid\regridder.py:513,</span> in <span class="ni">OverlapRegridder._compute_weights</span><span class="nt">(self, source, target, tolerance)</span>
<span class="g g-Whitespace">    </span><span class="mi">510</span> <span class="k">def</span><span class="w"> </span><span class="nf">_compute_weights</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">511</span>     <span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">512</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">513</span>     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_compute_weights</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\xugrid\regrid\regridder.py:426,</span> in <span class="ni">BaseOverlapRegridder._compute_weights</span><span class="nt">(self, source, target, relative)</span>
<span class="g g-Whitespace">    </span><span class="mi">424</span> <span class="k">def</span><span class="w"> </span><span class="nf">_compute_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">relative</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">425</span>     <span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">convert_to_match</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">426</span>     <span class="n">source_index</span><span class="p">,</span> <span class="n">target_index</span><span class="p">,</span> <span class="n">weight_values</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">overlap</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">427</span>         <span class="n">target</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="n">relative</span>
<span class="g g-Whitespace">    </span><span class="mi">428</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">429</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="n">MatrixCSR</span><span class="o">.</span><span class="n">from_triplet</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">430</span>         <span class="n">target_index</span><span class="p">,</span> <span class="n">source_index</span><span class="p">,</span> <span class="n">weight_values</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">target</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">size</span>
<span class="g g-Whitespace">    </span><span class="mi">431</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">432</span>     <span class="k">return</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\xugrid\regrid\unstructured.py:124,</span> in <span class="ni">UnstructuredGrid2d.overlap</span><span class="nt">(self, other, relative)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span> <span class="k">def</span><span class="w"> </span><span class="nf">overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">relative</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">107</span><span class="sd">     Parameters</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">     ----------</span>
<span class="sd">   (...)    118     weights: 1d np.ndarray of float</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span>     <span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>         <span class="n">target_index</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">122</span>         <span class="n">source_index</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">123</span>         <span class="n">weights</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">124</span>     <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ugrid_topology</span><span class="o">.</span><span class="n">celltree</span><span class="o">.</span><span class="n">intersect_faces</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">125</span>         <span class="n">vertices</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">ugrid_topology</span><span class="o">.</span><span class="n">node_coordinates</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">126</span>         <span class="n">faces</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">ugrid_topology</span><span class="o">.</span><span class="n">face_node_connectivity</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">127</span>         <span class="n">fill_value</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">ugrid_topology</span><span class="o">.</span><span class="n">fill_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">128</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">129</span>     <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span>         <span class="n">weights</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">area</span><span class="p">[</span><span class="n">source_index</span><span class="p">]</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba_celltree\celltree.py:253,</span> in <span class="ni">CellTree2d.intersect_faces</span><span class="nt">(self, vertices, faces, fill_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span> <span class="n">vertices</span> <span class="o">=</span> <span class="n">cast_vertices</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span> <span class="n">faces</span> <span class="o">=</span> <span class="n">cast_faces</span><span class="p">(</span><span class="n">faces</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">253</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locate_faces</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">254</span> <span class="n">area</span> <span class="o">=</span> <span class="n">area_of_intersection</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">255</span>     <span class="n">vertices_a</span><span class="o">=</span><span class="n">vertices</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">256</span>     <span class="n">vertices_b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>    <span class="mi">260</span>     <span class="n">indices_b</span><span class="o">=</span><span class="n">j</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">262</span> <span class="c1"># Separating axes declares polygons with shared edges as touching.</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span> <span class="c1"># Make sure we only include actual intersections.</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba_celltree\celltree.py:214,</span> in <span class="ni">CellTree2d.locate_faces</span><span class="nt">(self, vertices, faces)</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span> <span class="n">n_chunks</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">get_num_threads</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span> <span class="n">shortlist_i</span><span class="p">,</span> <span class="n">shortlist_j</span> <span class="o">=</span> <span class="n">locate_boxes</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">212</span>     <span class="n">bbox_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltree_data</span><span class="p">,</span> <span class="n">n_chunks</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span> <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">214</span> <span class="n">intersects</span> <span class="o">=</span> <span class="n">polygons_intersect</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">215</span>     <span class="n">vertices_a</span><span class="o">=</span><span class="n">vertices</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">216</span>     <span class="n">vertices_b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">217</span>     <span class="n">faces_a</span><span class="o">=</span><span class="n">faces</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">218</span>     <span class="n">faces_b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">219</span>     <span class="n">indices_a</span><span class="o">=</span><span class="n">shortlist_i</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">220</span>     <span class="n">indices_b</span><span class="o">=</span><span class="n">shortlist_j</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">222</span> <span class="k">return</span> <span class="n">shortlist_i</span><span class="p">[</span><span class="n">intersects</span><span class="p">],</span> <span class="n">shortlist_j</span><span class="p">[</span><span class="n">intersects</span><span class="p">]</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\dispatcher.py:376,</span> in <span class="ni">_DispatcherBase._compile_for_args</span><span class="nt">(self, *args, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">374</span> <span class="n">return_val</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">375</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">376</span>     <span class="n">return_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">argtypes</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">377</span> <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">ForceLiteralArg</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">378</span>     <span class="c1"># Received request for compiler re-entry with the list of arguments</span>
<span class="g g-Whitespace">    </span><span class="mi">379</span>     <span class="c1"># indicated by e.requested_args.</span>
<span class="g g-Whitespace">    </span><span class="mi">380</span>     <span class="c1"># First, check if any of these args are already Literal-ized</span>
<span class="g g-Whitespace">    </span><span class="mi">381</span>     <span class="n">already_lit_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">requested_args</span>
<span class="g g-Whitespace">    </span><span class="mi">382</span>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">types</span><span class="o">.</span><span class="n">Literal</span><span class="p">)]</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\dispatcher.py:904,</span> in <span class="ni">Dispatcher.compile</span><span class="nt">(self, sig)</span>
<span class="g g-Whitespace">    </span><span class="mi">902</span> <span class="k">with</span> <span class="n">ev</span><span class="o">.</span><span class="n">trigger_event</span><span class="p">(</span><span class="s2">&quot;numba:compile&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ev_details</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">903</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">904</span>         <span class="n">cres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiler</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">return_type</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">905</span>     <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">ForceLiteralArg</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">906</span>         <span class="k">def</span><span class="w"> </span><span class="nf">folded</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kws</span><span class="p">):</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\dispatcher.py:80,</span> in <span class="ni">_FunctionCompiler.compile</span><span class="nt">(self, args, return_type)</span>
<span class="g g-Whitespace">     </span><span class="mi">79</span> <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">return_type</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">80</span>     <span class="n">status</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_cached</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">return_type</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">81</span>     <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">82</span>         <span class="k">return</span> <span class="n">retval</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\dispatcher.py:94,</span> in <span class="ni">_FunctionCompiler._compile_cached</span><span class="nt">(self, args, return_type)</span>
<span class="g g-Whitespace">     </span><span class="mi">91</span>     <span class="k">pass</span>
<span class="g g-Whitespace">     </span><span class="mi">93</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">94</span>     <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_core</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">return_type</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">95</span> <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">TypingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">96</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_failed_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\dispatcher.py:107,</span> in <span class="ni">_FunctionCompiler._compile_core</span><span class="nt">(self, args, return_type)</span>
<span class="g g-Whitespace">    </span><span class="mi">104</span> <span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customize_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span> <span class="n">impl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_implementation</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">{})</span>
<span class="ne">--&gt; </span><span class="mi">107</span> <span class="n">cres</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">compile_extra</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetdescr</span><span class="o">.</span><span class="n">typing_context</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span>                               <span class="bp">self</span><span class="o">.</span><span class="n">targetdescr</span><span class="o">.</span><span class="n">target_context</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span>                               <span class="n">impl</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">110</span>                               <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="n">return_type</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">111</span>                               <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">112</span>                               <span class="n">pipeline_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_class</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">113</span> <span class="c1"># Check typing error if object mode is used</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span> <span class="k">if</span> <span class="n">cres</span><span class="o">.</span><span class="n">typing_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flags</span><span class="o">.</span><span class="n">enable_pyobject</span><span class="p">:</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\compiler.py:739,</span> in <span class="ni">compile_extra</span><span class="nt">(typingctx, targetctx, func, args, return_type, flags, locals, library, pipeline_class)</span>
<span class="g g-Whitespace">    </span><span class="mi">715</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;Compiler entry point</span>
<span class="g g-Whitespace">    </span><span class="mi">716</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">717</span><span class="sd"> Parameter</span>
<span class="sd">   (...)    735     compiler pipeline</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">737</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline_class</span><span class="p">(</span><span class="n">typingctx</span><span class="p">,</span> <span class="n">targetctx</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">738</span>                           <span class="n">args</span><span class="p">,</span> <span class="n">return_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">locals</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">739</span> <span class="k">return</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">compile_extra</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\compiler.py:439,</span> in <span class="ni">CompilerBase.compile_extra</span><span class="nt">(self, func)</span>
<span class="g g-Whitespace">    </span><span class="mi">437</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">lifted</span> <span class="o">=</span> <span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">438</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">lifted_from</span> <span class="o">=</span> <span class="kc">None</span>
<span class="ne">--&gt; </span><span class="mi">439</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_bytecode</span><span class="p">()</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\compiler.py:505,</span> in <span class="ni">CompilerBase._compile_bytecode</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">501</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">502</span><span class="sd"> Populate and run pipeline for bytecode input</span>
<span class="g g-Whitespace">    </span><span class="mi">503</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">504</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">func_ir</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="ne">--&gt; </span><span class="mi">505</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_core</span><span class="p">()</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\compiler.py:473,</span> in <span class="ni">CompilerBase._compile_core</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">471</span> <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">472</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">473</span>     <span class="n">pm</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">474</span>     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">cr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">475</span>         <span class="k">break</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\compiler_machinery.py:356,</span> in <span class="ni">PassManager.run</span><span class="nt">(self, state)</span>
<span class="g g-Whitespace">    </span><span class="mi">354</span> <span class="n">pass_inst</span> <span class="o">=</span> <span class="n">_pass_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pss</span><span class="p">)</span><span class="o">.</span><span class="n">pass_inst</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pass_inst</span><span class="p">,</span> <span class="n">CompilerPass</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">356</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_runPass</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">pass_inst</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">357</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">358</span>     <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="s2">&quot;Legacy pass in use&quot;</span><span class="p">)</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\compiler_lock.py:35,</span> in <span class="ni">_CompilerLock.__call__.&lt;locals&gt;._acquire_compile_lock</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span> <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span> <span class="k">def</span><span class="w"> </span><span class="nf">_acquire_compile_lock</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span>     <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">35</span>         <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\compiler_machinery.py:311,</span> in <span class="ni">PassManager._runPass</span><span class="nt">(self, index, pss, internal_state)</span>
<span class="g g-Whitespace">    </span><span class="mi">309</span>     <span class="n">mutated</span> <span class="o">|=</span> <span class="n">check</span><span class="p">(</span><span class="n">pss</span><span class="o">.</span><span class="n">run_initialization</span><span class="p">,</span> <span class="n">internal_state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> <span class="k">with</span> <span class="n">SimpleTimer</span><span class="p">()</span> <span class="k">as</span> <span class="n">pass_time</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">311</span>     <span class="n">mutated</span> <span class="o">|=</span> <span class="n">check</span><span class="p">(</span><span class="n">pss</span><span class="o">.</span><span class="n">run_pass</span><span class="p">,</span> <span class="n">internal_state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span> <span class="k">with</span> <span class="n">SimpleTimer</span><span class="p">()</span> <span class="k">as</span> <span class="n">finalize_time</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span>     <span class="n">mutated</span> <span class="o">|=</span> <span class="n">check</span><span class="p">(</span><span class="n">pss</span><span class="o">.</span><span class="n">run_finalizer</span><span class="p">,</span> <span class="n">internal_state</span><span class="p">)</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\compiler_machinery.py:272,</span> in <span class="ni">PassManager._runPass.&lt;locals&gt;.check</span><span class="nt">(func, compiler_state)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> <span class="k">def</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">compiler_state</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">272</span>     <span class="n">mangled</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">compiler_state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">273</span>     <span class="k">if</span> <span class="n">mangled</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">274</span>         <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CompilerPass implementations should return True/False. &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">275</span>                <span class="s2">&quot;CompilerPass with name &#39;</span><span class="si">%s</span><span class="s2">&#39; did not.&quot;</span><span class="p">)</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\typed_passes.py:247,</span> in <span class="ni">NopythonRewrites.run_pass</span><span class="nt">(self, state)</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span> <span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">246</span> <span class="k">with</span> <span class="n">fallback_context</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">247</span>     <span class="n">rewrites</span><span class="o">.</span><span class="n">rewrite_registry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="s1">&#39;after-inference&#39;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span> <span class="n">pp</span><span class="o">.</span><span class="n">remove_dels</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span> <span class="k">return</span> <span class="kc">True</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\rewrites\registry.py:94,</span> in <span class="ni">RewriteRegistry.apply</span><span class="nt">(self, kind, state)</span>
<span class="g g-Whitespace">     </span><span class="mi">92</span> <span class="kn">from</span><span class="w"> </span><span class="nn">numba.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">postproc</span>
<span class="g g-Whitespace">     </span><span class="mi">93</span> <span class="n">post_proc</span> <span class="o">=</span> <span class="n">postproc</span><span class="o">.</span><span class="n">PostProcessor</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">func_ir</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">94</span> <span class="n">post_proc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\postproc.py:84,</span> in <span class="ni">PostProcessor.run</span><span class="nt">(self, emit_dels, extend_lifetimes)</span>
<span class="g g-Whitespace">     </span><span class="mi">80</span> <span class="n">vlt</span> <span class="o">=</span> <span class="n">VariableLifetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func_ir</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">81</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_ir</span><span class="o">.</span><span class="n">variable_lifetime</span> <span class="o">=</span> <span class="n">vlt</span>
<span class="g g-Whitespace">     </span><span class="mi">83</span> <span class="n">bev</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">compute_live_variables</span><span class="p">(</span><span class="n">vlt</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_ir</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span>
<span class="ne">---&gt; </span><span class="mi">84</span>                                       <span class="n">vlt</span><span class="o">.</span><span class="n">usedefs</span><span class="o">.</span><span class="n">defmap</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">85</span>                                       <span class="n">vlt</span><span class="o">.</span><span class="n">deadmaps</span><span class="o">.</span><span class="n">combined</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">86</span> <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ir_block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_ir</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="g g-Whitespace">     </span><span class="mi">87</span>     <span class="bp">self</span><span class="o">.</span><span class="n">func_ir</span><span class="o">.</span><span class="n">block_entry_vars</span><span class="p">[</span><span class="n">ir_block</span><span class="p">]</span> <span class="o">=</span> <span class="n">bev</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\functools.py:1026,</span> in <span class="ni">cached_property.__get__</span><span class="nt">(self, instance, owner)</span>
<span class="g g-Whitespace">   </span><span class="mi">1024</span> <span class="n">val</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attrname</span><span class="p">,</span> <span class="n">_NOT_FOUND</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1025</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">_NOT_FOUND</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1026</span>     <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1027</span>     <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1028</span>         <span class="n">cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attrname</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\postproc.py:44,</span> in <span class="ni">VariableLifetime.usedefs</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span> <span class="nd">@cached_property</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span> <span class="k">def</span><span class="w"> </span><span class="nf">usedefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">44</span>     <span class="k">return</span> <span class="n">analysis</span><span class="o">.</span><span class="n">compute_use_defs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\analysis.py:52,</span> in <span class="ni">compute_use_defs</span><span class="nt">(blocks)</span>
<span class="g g-Whitespace">     </span><span class="mi">49</span>     <span class="k">if</span> <span class="n">stmt</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rhs_set</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span>         <span class="n">def_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">52</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">stmt</span><span class="o">.</span><span class="n">list_vars</span><span class="p">():</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>     <span class="c1"># do not include locally defined vars to use-map</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span>     <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">def_set</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span>         <span class="n">use_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\ir.py:355,</span> in <span class="ni">Stmt.list_vars</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">354</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">355</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_list_vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\ir.py:337,</span> in <span class="ni">Inst._rec_list_vars</span><span class="nt">(self, val)</span>
<span class="g g-Whitespace">    </span><span class="mi">335</span>     <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">    </span><span class="mi">336</span>     <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">337</span>         <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_list_vars</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">338</span>     <span class="k">return</span> <span class="n">lst</span>
<span class="g g-Whitespace">    </span><span class="mi">339</span> <span class="k">else</span><span class="p">:</span>

<span class="nn">File D:\a\lulucf-somers\lulucf-somers\.pixi\envs\default\Lib\site-packages\numba\core\ir.py:321,</span> in <span class="ni">Inst._rec_list_vars</span><span class="nt">(self, val)</span>
<span class="g g-Whitespace">    </span><span class="mi">316</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">317</span><span class="sd">     List the variables used (read or written) by the instruction.</span>
<span class="g g-Whitespace">    </span><span class="mi">318</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">319</span>     <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="ne">--&gt; </span><span class="mi">321</span> <span class="k">def</span><span class="w"> </span><span class="nf">_rec_list_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">322</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">323</span><span class="sd">     A recursive helper used to implement list_vars() in subclasses.</span>
<span class="g g-Whitespace">    </span><span class="mi">324</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Var</span><span class="p">):</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>If we look below at the shapes of each array, we can see how the arrays relate to eachother. Note that cell_idx and nitems have the same shape and polygon and area. Looping over nitems we know how many elements we have to mask in polygon and area to get the result for a cell. By using the cell_idx we can than place the results at the correct location in a grid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">area</span><span class="o">.</span><span class="n">cell_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">area</span><span class="o">.</span><span class="n">nitems</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">area</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">area</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(25,) (25,) (123,) (123,)
</pre></div>
</div>
</div>
</div>
<p>Remember that the values in <code class="docutils literal notranslate"><span class="pre">polygon</span></code> are the original row indices in the <code class="docutils literal notranslate"><span class="pre">polygons</span></code> GeoDataFrame so we can easily replace these indices with the “nr” of each polygon:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">area</span><span class="o">.</span><span class="n">polygon</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="s2">&quot;nr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">area</span><span class="o">.</span><span class="n">polygon</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PolygonGridArea(cell_idx=array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24]), nitems=array([ 5,  5,  6,  6,  2, 10,  7,  5,  5,  3,  4,  5, 10,  2,  5,  7,  3,
        5,  7,  3,  4,  5,  3,  4,  2]), polygon=array([2, 2, 2, 1, 1, 2, 2, 1, 2, 2, 1, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 2, 2, 1, 1, 2, 1, 1, 1, 1, 1,
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 1, 1, 1, 1, 2, 1, 2, 2, 1, 1, 1, 2, 1, 2, 2, 1, 1, 1, 1, 1,
       1, 2, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2]), area=array([1.41629806e-03, 2.90067895e-02, 8.81955013e-03, 6.53842718e-05,
       6.91978086e-04, 4.94451402e-03, 1.42361908e-02, 1.77869302e-03,
       6.48457379e-03, 1.25560284e-02, 2.87168464e-03, 1.21155042e-02,
       1.27129541e-03, 2.64864843e-03, 6.75262556e-03, 1.43402417e-02,
       7.00978213e-03, 3.01262119e-02, 3.94589069e-05, 4.41217793e-05,
       2.26987865e-06, 2.77815538e-03, 2.88945865e-02, 1.11054135e-02,
       3.43778330e-04, 2.33885034e-04, 3.94625898e-03, 7.17316229e-04,
       6.32953316e-04, 4.69617396e-03, 2.60602003e-04, 8.48726343e-03,
       4.18703901e-03, 1.64947297e-02, 6.61101453e-03, 1.23195861e-03,
       1.84687792e-02, 7.91041759e-04, 3.54480255e-04, 6.32333151e-03,
       6.21939418e-03, 3.73493003e-03, 1.62809195e-03, 1.67520273e-02,
       6.22506851e-04, 1.72624439e-02, 2.90655634e-03, 2.83349502e-02,
       6.68941587e-03, 3.34566157e-04, 1.73451141e-03, 1.62237526e-02,
       2.04839457e-03, 2.17278528e-02, 1.32907092e-02, 6.52781189e-03,
       1.07134681e-02, 9.46801078e-03, 5.43524197e-04, 7.26955871e-04,
       1.11126903e-03, 3.58759545e-02, 1.74229641e-03, 1.32118738e-02,
       2.64332615e-03, 2.03394342e-03, 6.65284161e-03, 6.84900367e-05,
       4.15541476e-03, 1.51191743e-03, 6.37373040e-03, 2.78145516e-03,
       5.67007246e-04, 2.60766428e-02, 1.39233572e-02, 1.73577920e-02,
       8.90906378e-03, 9.01610275e-03, 1.36250528e-03, 3.35453619e-03,
       2.84418639e-03, 1.00630068e-02, 1.33286772e-03, 1.51285778e-02,
       1.93320612e-03, 5.99916296e-03, 2.69899226e-03, 1.93805787e-02,
       5.41539741e-03, 1.52040239e-02, 1.03820885e-03, 2.06646479e-02,
       2.15776535e-03, 1.57935617e-02, 3.45816272e-04, 1.29489022e-02,
       1.70781841e-02, 1.38761737e-03, 2.03046264e-03, 2.62208668e-03,
       1.38579673e-03, 2.54695024e-03, 9.36669523e-04, 1.97131061e-02,
       1.93502244e-02, 5.10974749e-04, 6.19450415e-03, 1.83519685e-02,
       1.49425526e-02, 1.63363668e-03, 2.85805644e-02, 9.37522478e-03,
       1.53683524e-04, 2.56890580e-04, 3.49165159e-03, 4.43290827e-03,
       3.20754401e-02, 4.71971329e-03, 1.39528615e-02, 1.48789941e-03,
       1.98395258e-02, 3.84348388e-02, 1.56516121e-03]))
</pre></div>
</div>
</div>
</div>
<p>Now we can translate the results back into a grid. Numpy arrays are row-major so we can derive the row and column index by using the number of columns of the 2D grid and the cell_idx and place the results at the correct location in a grid.</p>
<p><code class="docutils literal notranslate"><span class="pre">row_idx,</span> <span class="pre">col_idx</span> <span class="pre">=</span> <span class="pre">np.divmod(cell_idx,</span> <span class="pre">ncols)</span></code></p>
<p>As an example, we will show for the first two iterations how the arrays are related.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ncols_grid</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Remember our grid is 5x5</span>

<span class="n">min_idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Mask always starts at 0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divmod</span><span class="p">(</span><span class="n">area</span><span class="o">.</span><span class="n">cell_idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ncols_grid</span><span class="p">)</span>
    <span class="n">nitems</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="n">nitems</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">max_idx</span> <span class="o">=</span> <span class="n">min_idx</span> <span class="o">+</span> <span class="n">nitems</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="n">polygon</span><span class="p">[</span><span class="n">min_idx</span><span class="p">:</span><span class="n">max_idx</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="n">area</span><span class="p">[</span><span class="n">min_idx</span><span class="p">:</span><span class="n">max_idx</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">=}</span><span class="s2">: </span><span class="si">{</span><span class="n">row_idx</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">col_idx</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">nitems</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">p</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">a</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">min_idx</span> <span class="o">+=</span> <span class="n">nitems</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>i=0: row_idx=np.int64(0), col_idx=np.int64(0), nitems=np.int64(5), p=array([2, 2, 2, 0, 0]), a=array([1.41629806e-03, 2.90067895e-02, 8.81955013e-03, 6.53842718e-05,
       6.91978086e-04])
i=1: row_idx=np.int64(0), col_idx=np.int64(1), nitems=np.int64(5), p=array([2, 2, 1, 2, 2]), a=array([0.00494451, 0.01423619, 0.00177869, 0.00648457, 0.01255603])
</pre></div>
</div>
</div>
</div>
<p>Now we can translate the namedtuple to a grid. The output will be a 3D grid (“y”, “x”, “layer”) with for each cell, the percentage that is covered by each type of polygon.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">units</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="s1">&#39;nr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="n">cell_area</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="mf">0.2</span>

<span class="n">area_grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">empty_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">units</span><span class="p">),</span> <span class="n">dask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">area_grid</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">area_to_grid3d</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">area_grid</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">area_grid</span> <span class="o">=</span> <span class="n">area_grid</span> <span class="o">/</span> <span class="n">cell_area</span>
<span class="n">area_grid</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme="dark"],
html[data-theme="dark"],
body[data-theme="dark"],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1f1f1f;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 0 20px 0 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: inline-block;
  opacity: 0;
  height: 0;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:focus + label {
  border: 2px solid var(--xr-font-color0);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: "►";
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: "▼";
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: "(";
}

.xr-dim-list:after {
  content: ")";
}

.xr-dim-list li:not(:last-child):after {
  content: ",";
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray (y: 5, x: 5, layer: 3)&gt; Size: 300B
array([[[0.01893406, 0.        , 0.9810659 ],
        [0.        , 0.04446733, 0.95553267],
        [0.07179212, 0.69317603, 0.23503186],
        [0.9283998 , 0.07160015, 0.        ],
        [1.        , 0.        , 0.        ]],

       [[0.85314524, 0.        , 0.1468548 ],
        [0.3333442 , 0.46171948, 0.20493636],
        [0.        , 1.        , 0.        ],
        [0.07266391, 0.9273361 , 0.        ],
        [0.40559384, 0.5944062 , 0.        ]],

       [[1.        , 0.        , 0.        ],
        [0.9586302 , 0.04136983, 0.        ],
        [0.12150949, 0.8784905 , 0.        ],
        [0.        , 1.        , 0.        ],
        [0.        , 0.882074  , 0.11792603]],

       [[0.71144146, 0.28855854, 0.        ],
        [0.13538493, 0.86461514, 0.        ],
        [0.        , 0.99135464, 0.00864541],
        [0.        , 0.4746812 , 0.5253188 ],
        [0.        , 0.02341674, 0.9765833 ]],

       [[0.01277437, 0.9872257 , 0.        ],
        [0.        , 0.7656194 , 0.23438063],
        [0.        , 0.198114  , 0.80188596],
        [0.        , 0.        , 1.        ],
        [0.        , 0.        , 1.        ]]], dtype=float32)
Coordinates:
  * y        (y) float64 40B 0.9 0.7 0.5 0.3 0.1
  * x        (x) float64 40B 0.1 0.3 0.5 0.7 0.9
  * layer    (layer) int32 12B 0 1 2</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'></div><ul class='xr-dim-list'><li><span class='xr-has-index'>y</span>: 5</li><li><span class='xr-has-index'>x</span>: 5</li><li><span class='xr-has-index'>layer</span>: 3</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-b08632ca-2e90-4542-b7d7-6309b544ac1a' class='xr-array-in' type='checkbox' checked><label for='section-b08632ca-2e90-4542-b7d7-6309b544ac1a' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>0.01893 0.0 0.9811 0.0 0.04447 0.9555 ... 0.0 0.0 1.0 0.0 0.0 1.0</span></div><div class='xr-array-data'><pre>array([[[0.01893406, 0.        , 0.9810659 ],
        [0.        , 0.04446733, 0.95553267],
        [0.07179212, 0.69317603, 0.23503186],
        [0.9283998 , 0.07160015, 0.        ],
        [1.        , 0.        , 0.        ]],

       [[0.85314524, 0.        , 0.1468548 ],
        [0.3333442 , 0.46171948, 0.20493636],
        [0.        , 1.        , 0.        ],
        [0.07266391, 0.9273361 , 0.        ],
        [0.40559384, 0.5944062 , 0.        ]],

       [[1.        , 0.        , 0.        ],
        [0.9586302 , 0.04136983, 0.        ],
        [0.12150949, 0.8784905 , 0.        ],
        [0.        , 1.        , 0.        ],
        [0.        , 0.882074  , 0.11792603]],

       [[0.71144146, 0.28855854, 0.        ],
        [0.13538493, 0.86461514, 0.        ],
        [0.        , 0.99135464, 0.00864541],
        [0.        , 0.4746812 , 0.5253188 ],
        [0.        , 0.02341674, 0.9765833 ]],

       [[0.01277437, 0.9872257 , 0.        ],
        [0.        , 0.7656194 , 0.23438063],
        [0.        , 0.198114  , 0.80188596],
        [0.        , 0.        , 1.        ],
        [0.        , 0.        , 1.        ]]], dtype=float32)</pre></div></div></li><li class='xr-section-item'><input id='section-702a7999-8ea7-44c5-9577-4e6d3d09d4d9' class='xr-section-summary-in' type='checkbox'  checked><label for='section-702a7999-8ea7-44c5-9577-4e6d3d09d4d9' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>y</span></div><div class='xr-var-dims'>(y)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.9 0.7 0.5 0.3 0.1</div><input id='attrs-62275f97-a765-4058-b5da-e60033243524' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-62275f97-a765-4058-b5da-e60033243524' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c6a57c7b-0d94-4237-af6d-4a6e61c3d08b' class='xr-var-data-in' type='checkbox'><label for='data-c6a57c7b-0d94-4237-af6d-4a6e61c3d08b' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([0.9, 0.7, 0.5, 0.3, 0.1])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>x</span></div><div class='xr-var-dims'>(x)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.1 0.3 0.5 0.7 0.9</div><input id='attrs-241b5237-85a4-4e77-a2a4-0dff6df8c27c' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-241b5237-85a4-4e77-a2a4-0dff6df8c27c' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-b6a04635-6510-45e6-821a-d6a7959f6417' class='xr-var-data-in' type='checkbox'><label for='data-b6a04635-6510-45e6-821a-d6a7959f6417' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([0.1, 0.3, 0.5, 0.7, 0.9])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>layer</span></div><div class='xr-var-dims'>(layer)</div><div class='xr-var-dtype'>int32</div><div class='xr-var-preview xr-preview'>0 1 2</div><input id='attrs-51362973-14b0-4eb3-8ad4-e1a6d563c59e' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-51362973-14b0-4eb3-8ad4-e1a6d563c59e' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f1c15e38-8333-44af-a7f1-cec376dd2b87' class='xr-var-data-in' type='checkbox'><label for='data-f1c15e38-8333-44af-a7f1-cec376dd2b87' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([0, 1, 2], dtype=int32)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-efba39e0-f946-44a6-bafc-eb1b41cb96ee' class='xr-section-summary-in' type='checkbox'  ><label for='section-efba39e0-f946-44a6-bafc-eb1b41cb96ee' class='xr-section-summary' >Indexes: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>y</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-a9743094-fc03-461b-84b4-a0d4e995f8bf' class='xr-index-data-in' type='checkbox'/><label for='index-a9743094-fc03-461b-84b4-a0d4e995f8bf' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([0.9, 0.7, 0.4999999999999999, 0.2999999999999998, 0.09999999999999976], dtype=&#x27;float64&#x27;, name=&#x27;y&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>x</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-30dc9f09-53fc-4cfc-b968-f063601d7209' class='xr-index-data-in' type='checkbox'/><label for='index-30dc9f09-53fc-4cfc-b968-f063601d7209' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([                0.1, 0.30000000000000004,  0.5000000000000001,
        0.7000000000000001,  0.9000000000000001],
      dtype=&#x27;float64&#x27;, name=&#x27;x&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>layer</div></div><div class='xr-index-preview'>PandasIndex</div><input type='checkbox' disabled/><label></label><input id='index-14538561-45ee-45bb-982f-9d0b29550f18' class='xr-index-data-in' type='checkbox'/><label for='index-14538561-45ee-45bb-982f-9d0b29550f18' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([0, 1, 2], dtype=&#x27;int32&#x27;, name=&#x27;layer&#x27;))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-7f1e697a-4892-44fd-bf42-82ee66566048' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-7f1e697a-4892-44fd-bf42-82ee66566048' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</div>
<p>Let’s show the polygons again and for instance check the result of the center cell (see highlighted cell). This cell is covered by four different polygons with two unique “nrs”: 0 and 1. We can see, approximately 12% of the cell is covered by nr 0 and approximately 88% is covered by nr 1 which is in agreement with the image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">polygons</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">column</span><span class="o">=</span><span class="s1">&#39;nr&#39;</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Pastel2&#39;</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">legend_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bbox_to_anchor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="s1">&#39;upper right&#39;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">cells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">cells</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Highlight center cell</span>
<span class="nb">print</span><span class="p">(</span><span class="n">area_grid</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (layer: 3)&gt; Size: 12B
array([0.12150949, 0.8784905 , 0.        ], dtype=float32)
Coordinates:
    y        float64 8B 0.5
    x        float64 8B 0.5
  * layer    (layer) int32 12B 0 1 2
</pre></div>
</div>
<img alt="../_images/1296029958be5ca7279bdd878d59c699e4e42358ebe30638cb171c86d8ccf302.png" src="../_images/1296029958be5ca7279bdd878d59c699e4e42358ebe30638cb171c86d8ccf302.png" />
</div>
</div>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../user_guide.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">User guide</p>
      </div>
    </a>
    <a class="right-next"
       href="coverage.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Calculate coverage example</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/user_guide/concept.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, Deltares.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>